<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blind Test</title>
    <style>
    </style>
</head>
<body>
    <h2>Blind Test de ouf</h2>
    <style>
      .correct {
          background-color: green;
      }
  </style>

    <iframe id="spotifyIframe" class="spotifyIframe" src="https://open.spotify.com/embed/track/53EgqZOqiGrnpCCX9Uj2Qw?start=35" width="100%" height="352" frameborder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
    <style>
        .spotifyIframe {
            filter:blur(10px)
        }
    </style>
    <div id="timer" class="timer">Timer</div>
    <div id="title" class="title">title</div>
    <div id="username" class="score">username</div>


    <input id="answer" type="text">
    <button onclick="startSending()">Start Sending</button>
        
    <script>
          var params = new URLSearchParams(window.location.search);
          var roomID = params.get("room");
          var ws = new WebSocket("ws://10.70.5.231:8080/BlindTest/webs");
          ws.onopen = ()=>console.log("open ws")
          ws.onclose = ()=>console.log("close ws")
          ws.onmessage = function (event) {
            console.log(event)
            var data = JSON.parse(event.data);
            console.log(data);
            if (data.event == "fetchData") {
              collectAndSendValues();
              console.log("ouais Ã§a passe")
            } else if (data.event == "timer") {
              var timer = document.getElementById("timer");
              timer.textContent = data.time;
              var title = document.getElementById("title");
              title.textContent = "Titre de la piste : " + data.title;
              var username = document.getElementById("username");
              username.textContent = data.username
              checkAnswer(data.title);
            } else if (data.event == "music") {
              var spotifyIframe = document.getElementById("spotifyIframe");
              spotifyIframe.src = data.music;
              answer.value = ""
            } else if (data.event == "userscore") {
              var scorediv = document.getElementById("score");
              scorediv.textContent = data.username;
              console.log(data.username)
              console.log("c'est good !")
            }
          };

          function startSending() {
            var inputText = document.getElementById('answer').value;

            const dataToSend = {
              Event: "answer",
              Answer: inputText,
            };

            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify(dataToSend));
            } else {
              console.error("WebSocket is not open.");
            }

        }

          function checkAnswer(title) {
            var answerInput = document.getElementById('answer');
            var answerValue = answerInput.value.toLowerCase();
            if (title.toLowerCase() === answerValue) {
              answerInput.classList.add('correct');
            } else {
              answerInput.classList.remove('correct');
            }
          }

          function collectAndSendValues() {
            var answerInput = document.getElementById('answer');
            var answerValue = answerInput.value;

            const dataToSend = {
              event: "answer",
              answer: answerValue,
            };

            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify(dataToSend));
            } else {
              console.error("WebSocket is not open.");
            }
          }

          function sendAnswer(answer) {
            const dataToSend = {
              Event: "answer",
              Answer: answer
            };
            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify(dataToSend));
            } else {
              console.error("WebSocket is not open.");
            }
          }
      </script>
</body>
</html>